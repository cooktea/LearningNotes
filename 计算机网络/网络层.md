# 网络层
![框架](http://cdn.imkiwi.top/%E7%BD%91%E7%BB%9C%E5%B1%82.png)

## 概述
网络层关注的问题是源主机如何将分组沿着网络路径送达目的主机。同时避免某些链路或路由器负载过重，某些缺空闲的情况。
### 分组转发
分组转发是当一个分组到达路由器时，路由器将其转发到适当的输出链路。所以路由器必须要维护一张转发表，根据转发表确定分组的转发出口。
### 路由选择
网络层决定分组在网络中的传输的路径称为路由选择。路由选择生成一张路由表，再根据路由表生成转发表。
### 提供的服务
#### 面向连接的服务
面向连接服务的计算机网络称为虚电路网络。该网络在两台计算机进行通信时必须先建立连接，即建立一条端到端的数据链路。之后所有的数据都通过这条数据链路进行传输。当数据传输完毕时再释放这条数据链路。例如电话网。
#### 无连接的服务
无连接服务的网络称位数据报网络。该网络只提供简单灵活、无连接、尽最大努力交付的数据报服务。网络在发送分组时不需要建立连接。所以分组在传送时有可能出错、丢失、重复和失序。
## IP协议
IP协议的配套协议：  
- 地址解析协议（Address Resolution Protocol ， ARP）
- 逆地址解析协议（Reserve Address Resolution Protocol ， RARP）
- 网际控制报文协议（Internet Control Message Protocol ， ICMP）
- 网际组管理协议（Internet Group Management Protocol ， IGMP   
### IP协议及其配套协议
![IP协议及其配套协议](http://cdn.imkiwi.top/1569054157.015124.jpg)
### 异构网络互连
- 将不同的网络连接起来需要使用的中间设备：   
  1. 物理层使用转发器
  2. 数据链路层使用网桥或桥接器
  3. 网络层使用路由器
  4. 网络层以上使用网关
### IP地址
IP地址是因特网上的每一个主机或路由器的接口分配给一个在全世界范围内唯一的32为标识符。
- 点分十进制：将32位标识符每隔八位使用十进制表示，并在十进制数之间用点隔开。
- IP编址方式：
  1. 分类编址
  2. 划分子网
  3. 无分类编址
#### 分类编址
该分类方式将IP地址划分为若干个固定的类。每一个类都由两个固定长度的字段组成，分别是网络号和主机号。网络号在整个因特网中必须是唯一的，主机号在所在的网络中必须是唯一的。   
IP地址管理机构在分配IP地址时只分配网络号，路由器仅根据主机所连接的网络号进行分组转发，减少了路由表的占用空间和检索时间。  
- IP地址分类     
  ![IP地址分类](http://cdn.imkiwi.top/1569055595.879577.jpg)
  - A类地址：1 - 126
  - B类地址：128 - 191
  - C类地址：192 - 223
#### 划分子网
IP地址从两级编号变为三级编号，分贝是网络号、子网号和主机号。其中子网号不定长。
#### 无分类编址
- 无分类域间路由选择（CIDR）消除了传统的A、B、C类地址以及子网划分的概念。   
  CIDR将32位的IP地址划分为两个部分，前一部分时不定长的网络前缀，代替网络号来知名网络，后一部分则是主机号，用来指明主机。
- 子网掩码:子网掩码是一个32位的地址掩码，将子网掩码与IP地址相与后得到网络前缀，由此得到该IP地址的网络。该网络的地址为网络前缀后全为0的地址。
- CIRD记法：IP地址后跟一个数字，用/与IP地址隔开，表示该IP地址的子网掩码前面有多少位1。
#### 特殊的IP地址
![特殊的IP地址](http://cdn.imkiwi.top/%E7%89%B9%E6%AE%8AIP%E5%9C%B0%E5%9D%80.png)
#### IP地址与物理地址
- IP地址是网络层使用的地址
- 物理地址是数据链路层使用的地址
- IP地址放在IP数据报的首部
- 物理地址放在MAC帧的首部
### 地址解析协议ARP
ARP协议是一种能够将IP地址映射到物理地址的协议，该映射自动进行。
- 主机A向局域网中的主机B发送IP数据报：A首先在ARP高速缓存中查找B的IP地址，如果能够查找到，则获取其物理地址后封装成MAC帧进行发送。如果查找不到，则A自动运行ARP，ARP运行过程如下：  
  1. 在局域网广播发送一个ARP分组，其中的信息包含A的IP地址和物理地址以及想要直到IP地址为B的IP地址的物理地址
  2. 局域网中所有运行ARP协议的主机都能收到这条信息，收到信息的主机刷新自己的ARP高速缓存，更新A的IP地址到物理地址的映射信息。
  3. 主机B在收到的信息中发现自己的IP地址，就向A发送ARP响应分组，响应中包含自己的物理地址。同时在自己的ARP高速缓存中写入A的IP地址和物理地址的映射信息。
  4. A收到响应分组后就在高速缓存中写入B的IP地址与物理地址的映射信息。
- ARP高速缓存中的每一条映射信息都有一个生存时间，超过生存时间的映射信息将被删除，以防主机的物理地址发生改变。
### IP数据报
![数据报格式](http://cdn.imkiwi.top/IP%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%A0%BC%E5%BC%8F.png)
#### 各字段意义
- 版本:IP协议的版本，常用的协议号为4（IPV4）
- 首部长度：该字段的单位是4字节，标识该数据报首部的长度。
- 区分服务：一般情况下不使用。
- 总长度：首部和数据部分的长度和，单位是字节。
- 标识：每产生一个数据报，IP软件中的计数器就会加一，并将计数器的值写入该字段。
- 标志：当最低位为1，表示后面还有分片，中间位为1，表示不能分片
- 片偏移：当长分组被分片后，某片在原分组中的相对位置。该字段的单位为8字节。
- 生存时间：表示数据报在网络中的寿命，目的是防止数据报在网络中无限制的转发。每当经过一个路由器，生存时间减一。当生存时间为0时，路由器不再进行转发。
- 协议：表示该数据报承载的数据使用的何种协议。   
  1. ICMP：1
  2. IGMP：2
  3. TCP：6
  4. EGP：8
  5. IGP：9
  6. UDP：17
  7. IPv6：41
  8. OSPF：89
- 首部检验和：该检验字段值检验IP数据报的首部，不包括数据部分。 
### IP数据报转发
#### 路由表
路由表中包含网络地址，子网掩码，下一跳和端口。数据报的IP地址和子网掩码相与可以得到网络地址，再根据得到的网络地址选择下一跳地址或转发的接口。
#### 转发流程
1. 从收到的数据报中提取目的IP地址A1
2. 首先判断是否是直接交付，即将与路由器连接的各网络的子网掩码和A1进行相与，如果得到了对应的网络地址，则将分组直接交付（将分组封装成MAC帧进行交付）。如果没有相匹配的网络地址，则简介交付。
3. 将A1和路由表中每一行的子网掩码进行相与，若和该行的网络地址相同，则将该数据报转发给改行对应的下一跳路由器。
4. 若仍没有匹配成功，则转发给路由表中指明的默认路由器。
5. 若没有默认路由器，则报告出错。
#### 路由聚合
路由表中可能存在多个网络的下一跳地址相同，且这些网络可以合并成一个CIDR地址块。这样可以大大减少路由表中的数据量。
#### 最长前缀匹配
由于采用了路由聚合技术，导致在查找路由表时可能会得到不止一个结果。当检索结果不止一个时，则选择具有最长网络前缀的结果。因为网络前缀越长，该网络的规模就越小，得到的地址就越具体。
## 网际控制报文协议ICMP
![ICMP报文](http://cdn.imkiwi.top/ICMP%E6%8A%A5%E6%96%87.png)
### 种类
- 差错报告报文
  1. 终点不可达：3
  2. 源点抑制：4
  3. 超时：11
  4. 参数问题：12
  5. 改变路由：5
- 询问报文
  1. 回送（Echo）请求或回答：8或0
  2. 时间戳（Timestamp）请求或回答：13或14
#### 差错报告报文
1. 终点不可达：路由器或主机不能交付数据报时，就向源点发送终点不可达报文。可根据ICMP代码字段的值分为目的网络不可达、目的主机不可达、目的协议不可达、目的端口不可达、目的网络未知和目的主机未知等。
2. 源点抑制：路由器或主机由于网络拥塞而丢弃数据报时，向源点发送源点抑制报文，使源点的数据报发送速率降低。
3. 超时：当路由器收到IP数据报后，将数据报中的TTL值减一，当TTL值减为0后则丢弃该数据报并向源点发送超时报文。或终点在规定时间内不能收到一个数据报的全部分片时，就会丢弃已收到的所有分片并向源点发送超时报文。
4. 参数问题：路由器或主机收到的数据报首部中有字段的值不正确，则丢弃该数据报并向源点发送参数问题报文。
5. 改变路由：路由器向主机发送的改变路由报文可以修改主机对于某个网络地址的默认选择路由器，以此可以改善路由效率。

- Tips：不发送差错报文的情况：   
  1. 对第一个分片的数据报片的所有后续分片都不发送ICMP差错报告报文
  2. 对具有多播地址的数据报都不发送差错报告报文
  3. 对具有特殊地址（127.0.0.0或0.0.0.0）的数据报不发送差错报告报文
#### 查询报文
1. 回送请求和回答报文：该报文是主机或路由器向特定目的主机发送的询问报文，目的主机必须发送回答报文。以得知目的主机的状态和可达性。
2. 时间戳请求和回答报文：该报文是请某个主机或路由器回答当前日期和时间的报文，用来进行时钟同步和测量时间。
## 路由选择协议
### 基本概念
### 内部网关协议
#### RIP
#### OSPF
### 外部网关协议
## 路由器工作原理
### 路由器构成
### 路由器和交换机比较
## VPN
## NAT
## IP多播
### 基本概念
### IGMP协议
### 多播路由选择协议
## 移动IP
## IPV6
### 数据报
### 编址
### IPV4 2 IPV6